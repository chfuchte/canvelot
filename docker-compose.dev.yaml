services:
    mongodb:
        image: docker.io/mongodb/mongodb-community-server:8.2.4-ubi8
        restart: on-failure
        volumes:
            - mongodb_data:/data/db
        ports:
            - ${MONGODB_PORT_NUMBER:-27017}:27017
        environment:
            MONGODB_REPLICA_SET_NAME: ${MONGODB_REPLICA_SET_NAME:-rs0}
            MONGODB_PORT_NUMBER: ${MONGODB_PORT_NUMBER:-27017}
            MONGODB_INITIAL_PRIMARY_HOST: ${MONGODB_INITIAL_PRIMARY_HOST:-localhost}
        entrypoint: |
            bash -c 
                "mongod --replSet $$MONGODB_REPLICA_SET_NAME --bind_ip_all &
                    sleep 2;
                    until mongosh --eval \"db.adminCommand('ping')\"; do 
                        echo '=====> Waiting for Mongo...';
                        sleep 1;
                    done;
                    echo \"=====> Initiating ReplSet $$MONGODB_REPLICA_SET_NAME at $$MONGODB_INITIAL_PRIMARY_HOST:$$MONGODB_PORT_NUMBER...\";
                    mongosh --eval \"rs.initiate({_id: '$$MONGODB_REPLICA_SET_NAME', members: [{ _id: 0, host: '$$MONGODB_INITIAL_PRIMARY_HOST:$$MONGODB_PORT_NUMBER' }]})\";
                    echo '=====> Initiating ReplSet done...';
                wait"

volumes:
    mongodb_data:
